# brr AWS template â€” single L4 GPU node
# Based on Ray cluster YAML: https://docs.ray.io/en/latest/cluster/vms/references/ray-cluster-configuration.html
#
# {{VAR}} placeholders are filled from ~/.brr/config.env (set by `brr configure`).
# brr auto-injects setup.sh, file_mounts, and project setup into the final YAML.
# Add setup_commands to run your own commands after brr setup completes.
# Override fields via CLI: brr up l4 instance_type=g6.2xlarge spot=true

cluster_name: l4
max_workers: 0

provider:
  type: aws
  region: us-east-1
  availability_zone: us-east-1a, us-east-1b, us-east-1c, us-east-1d
  cache_stopped_nodes: True # If not present, the default is True.

auth:
  ssh_user: ubuntu
  ssh_private_key: {{AWS_SSH_KEY}}

head_node_type: ray.head.default

available_node_types:
  ray.head.default:
    resources: {}
    node_config:
      InstanceType: gr6.4xlarge # L4 GPU https://aws.amazon.com/ec2/instance-types/g6/
      ImageId: {{AMI_DL}}
      KeyName: {{AWS_KEY_NAME}}
      SecurityGroupIds: ["{{AWS_SECURITY_GROUP}}"]
      BlockDeviceMappings:
        - DeviceName: /dev/sda1
          Ebs:
            VolumeSize: 200
            VolumeType: gp3

# Upload local files/dirs to all nodes (merged with brr's own file_mounts).
# file_mounts:
#   /remote/path: /local/path

# Commands run on all nodes after brr's setup.sh (and project setup.sh if present).
# setup_commands:
#   - pip install my-package

# Commands run only on the head node after setup_commands.
# head_setup_commands:
#   - echo "head node ready"

# Commands run only on worker nodes after setup_commands.
# worker_setup_commands:
#   - echo "worker ready"

head_start_ray_commands:
    - source /tmp/brr/venv/bin/activate && ray stop
    - source /tmp/brr/venv/bin/activate && ray start --head --port=6379 --object-manager-port=8076 --autoscaling-config=~/ray_bootstrap_config.yaml --dashboard-host=0.0.0.0

worker_start_ray_commands:
    - source /tmp/brr/venv/bin/activate && ray stop
    - source /tmp/brr/venv/bin/activate && ray start --address=$RAY_HEAD_IP:6379 --object-manager-port=8076
